<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Result - NEB</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f2f2f2;
      padding: 30px;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background-color: white;
      padding: 30px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h2, h3 {
      text-align: center;
      color: #2c3e50;
    }

    form {
      margin-top: 20px;
      text-align: center;
    }

    input[type="text"], input[type="date"] {
      width: 45%;
      padding: 8px;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background-color: #006699;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #004f80;
    }

    .result-section {
      margin-top: 30px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table, th, td {
      border: 1px solid #999;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    .download-btn {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>National Examination Board</h2>
    <h3>View Student Result</h3>

    <form id="resultForm">
      <input type="text" id="symbol" placeholder="Enter Symbol Number" required />
      <input type="date" id="dob" max="2025-04-25" required />
      <br>
      <button type="submit">View Result</button>
    </form>

    <div class="result-section" id="resultSection" style="display:none;">
      <h3>Result Sheet</h3>
      <p><strong>Name:</strong> <span id="nameDisplay"></span></p>
      <p><strong>Symbol No.:</strong> <span id="symbolDisplay"></span></p>
      <p><strong>Date of Birth:</strong> <span id="dobDisplay"></span></p>

      <table>
        <thead>
          <tr>
            <th>Subject</th>
            <th>Grade</th>
          </tr>
        </thead>
        <tbody id="resultTable"></tbody>
      </table>

      <div class="download-btn">
        <button onclick="downloadPDF()">Download PDF</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBTqK2cKF8HcfmbxCKYiGVHjEFSzp_Z5rI",
        authDomain: "studentgrades-2d64f.firebaseapp.com",
        projectId: "studentgrades-2d64f",
        storageBucket: "studentgrades-2d64f.firebasestorage.app",
        messagingSenderId: "1074997371804",
        appId: "1:1074997371804:web:c19985f72b08830803de59",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.getElementById('resultForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const symbol = document.getElementById('symbol').value;
      const dob = document.getElementById('dob').value;

      db.collection("students")
        .where("symbol", "==", symbol)
        .where("dob", "==", dob)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            alert("No record found!");
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            document.getElementById('nameDisplay').textContent = data.name;
            document.getElementById('symbolDisplay').textContent = data.symbol;
            document.getElementById('dobDisplay').textContent = data.dob;

            const table = document.getElementById('resultTable');
            table.innerHTML = '';

            if (Array.isArray(data.results)) {
              data.results.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.subject}</td><td>${row.grade}</td>`;
                table.appendChild(tr);
              });
            }

            document.getElementById('resultSection').style.display = 'block';
          });
        })
        .catch(error => {
          alert("Error retrieving result: " + error.message);
        });
    });

    async function downloadPDF() {
      const jsPDF = window.jspdf.jsPDF;
      const doc = new jsPDF();

      const name = document.getElementById('nameDisplay').textContent;
      const symbol = document.getElementById('symbolDisplay').textContent;
      const dob = document.getElementById('dobDisplay').textContent;

      doc.setFontSize(14);
      doc.text("National Examination Board", 20, 20);
      doc.setFontSize(12);
      doc.text(`Name: ${name}`, 20, 35);
      doc.text(`Symbol No: ${symbol}`, 20, 45);
      doc.text(`Date of Birth: ${dob}`, 20, 55);

      doc.autoTable({
        startY: 65,
        head: [["Subject", "Grade"]],
        body: Array.from(document.querySelectorAll('#resultTable tr')).map(tr => {
          const cells = tr.querySelectorAll('td');
          return [cells[0].textContent, cells[1].textContent];
        })
      });

      doc.save(`${symbol}_Result.pdf`);
    }
  </script>
</body>
</html>
